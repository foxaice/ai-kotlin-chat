#!/bin/bash

echo "üé¨ –î–ï–ú–û–ù–°–¢–†–ê–¶–ò–Ø: –¶–µ–ø–æ—á–∫–∞ –∏–∑ –¥–≤—É—Ö MCP —Å–µ—Ä–≤–µ—Ä–æ–≤"
echo "=================================================="
echo ""

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
if [ ! -f ".env" ]; then
    echo "‚ùå –°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª .env —Å —Ç–æ–∫–µ–Ω–∞–º–∏"
    exit 1
fi

set -a; source .env; set +a

echo "‚úÖ –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω—ã"
echo "üìã –ì–æ—Ç–æ–≤–∏–º —Å–∏—Å—Ç–µ–º—É..."

# –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
echo "üî® –°–±–æ—Ä–∫–∞ Kotlin –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
./gradlew installDist > /dev/null 2>&1

echo "üî® –°–±–æ—Ä–∫–∞ Telegram MCP —Å–µ—Ä–≤–µ—Ä–∞..."
cd telegram-mcp-server
npm install > /dev/null 2>&1
npm run build > /dev/null 2>&1
cd ..

echo "üî® –°–±–æ—Ä–∫–∞ Todoist MCP —Å–µ—Ä–≤–µ—Ä–∞..."
cd todoist-mcp-server  
npm install > /dev/null 2>&1
npm run build > /dev/null 2>&1
cd ..

# –ù–∞—Ö–æ–¥–∏–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø—É—Ç—å
APP_DIR=$(find build/install -name "lib" -type d | head -1 | xargs dirname)
echo "üìÅ –ù–∞–π–¥–µ–Ω–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è: $APP_DIR"

echo ""
echo "üöÄ –ó–ê–ü–£–°–ö –¶–ï–ü–û–ß–ö–ò MCP –°–ï–†–í–ï–†–û–í"
echo "================================"
echo ""
echo "–°–∏—Å—Ç–µ–º–∞ –±—É–¥–µ—Ç:"
echo "1. üìã –ü–æ–¥–∫–ª—é—á–∞—Ç—å—Å—è –∫ Todoist MCP"
echo "2. üì± –ü–æ–¥–∫–ª—é—á–∞—Ç—å—Å—è –∫ Telegram MCP" 
echo "3. üîó –ü–æ–ª—É—á–∞—Ç—å –∑–∞–¥–∞—á–∏ –∏–∑ Todoist"
echo "4. üé® –ö—Ä–∞—Å–∏–≤–æ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å –∏—Ö"
echo "5. üì§ –û—Ç–ø—Ä–∞–≤–ª—è—Ç—å –≤ –≤–∞—à Telegram"
echo ""
echo "–ò–Ω—Ç–µ—Ä–≤–∞–ª: –∫–∞–∂–¥—ã–µ 20 —Å–µ–∫—É–Ω–¥"
echo "–î–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–∞–∂–º–∏—Ç–µ Ctrl+C"
echo ""
echo "‚ñ∂Ô∏è  –ó–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã..."
sleep 3

# –ó–∞–ø—É—Å–∫–∞–µ–º —Å–∏—Å—Ç–µ–º—É —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º –ø—É—Ç–µ–º
java -cp "$APP_DIR/lib/*" job.JobMainKt \
    --intervalSeconds=20 \
    --useMcpChain=true \
    --input=/mcp-chain
